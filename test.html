<!DOCTYPE html>
<html lang="ja">
<head>
<title>qr code</title>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<link rel="stylesheet" href="http://view.jquery.com/trunk/qunit/testsuite.css" type="text/css" media="screen" />
<script type="text/javascript" src="http://view.jquery.com/trunk/qunit/testrunner.js"></script>
<script type="text/javascript" src="readsolomon.js"></script>
<script type="text/javascript" src="bitstage.js"></script>
<script type="text/javascript" src="bitstage.test.js"></script>
<script type="text/javascript" src="reedsolomon.js"></script>
<script type="text/javascript" src="reedsolomon.test.js"></script>
<script type="text/javascript" src="bch_15_5.js"></script>
<script type="text/javascript" src="bch_15_5.test.js"></script>
<script type="text/javascript" src="qrcode.base.js"></script>
<script type="text/javascript" src="qrcode.symbol.calcsize.js"></script>
<script type="text/javascript" src="qrcode.symbol.calcsize.test.js"></script>
<script type="text/javascript" src="qrcode.symbol.drawer.js"></script>
<script language="JavaScript">
//モード指示子(mode indicator)
var _encode_mode = {
	numeric:		0x01 //数字モード
	,alphabetic:	0x02 //英数モード
	,octetbyte:		0x04 //8bitバイトモード
	,multibyte:		0x08 //漢字モード
};
//文字数指示子(character count indicator)
var _char_count = [];
_char_count[_encode_mode.numeric]		= [10,12,14];
_char_count[_encode_mode.alphabetic]	= [ 9,11,13];
_char_count[_encode_mode.octetbyte]		= [ 8,16,16];
_char_count[_encode_mode.multibyte]		= [ 8,10,12];


var _c = {
	numeric:	{//数字モード
		typecode: 0x01
		,charcount:	[10,12,14]
		,chardic: '0123456789'
		,selectid: 0
		,bitblock: 10
		,baselen: 0
		,transcode: function (str){
			var _len = str.length;
			var _ret = [];
			this.baselen = _len;
			for(var i=0;i<_len;i+=3)
			{
				_ret.push(parseInt(str.substr(i,3),10));
			}
			return _ret;
		}
		
	}
	,alphabetic:{//英数モード
		typecode: 0x02
		,charcount:	[ 9,11,13]
		,chardic: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:'
		,bitblock: 11
		,baselen: 0
		,transcode: function (str){
			var _len = this.chardic.length;
			var _ret = [];
			var _cache = [];
			for(var i=0;i<_len;i++)
			{
				_cache[this.chardic.substr(i,1)] = i;
			}
			_len = str.length;
			this.baselen = _len;
			for(var i=0;i<_len;i+=2)
			{
				
				_ret.push(parseInt(str.substr(i,3),10));
			}
			return _ret;
		}
	
	}
	,octetbyte:	{//8bitバイトモード
		typecode: 0x04
		,charcount:	[ 8,16,16]
	}
	,multibyte:	{//漢字モード
		typecode: 0x08
		,charcount:	[ 8,10,12]
	}
	
}

var _work = new bitstrage(8);

function _alphabetic(str,level){
	
	var _ret = [];
	var _cache = [];
	var _chardic = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:';
	var _len = _chardic.length;
	for(var i=0;i<_len;i++)
	{
		_cache[_chardic.substr(i,1)] = i;
	}
	_len = str.length;
	var _bitwork = _getHeader(level,0x02,[ 9,11,13],_len);
	for(var i=0;i<_len;i+=2)
	{
		var _work = (_cache[str.substr(i,1)]*_len) + _cache[str.substr(i+1,1)];
		_bitwork.push(_work,11);
	}
	return _bitwork;
}


function _getHeader(ver,typecode,charcounts,len){
	var bitst = new bitstrage(8);
	bitst.push(ver,4);
	var _countInputCounts = 0;
	if(ver<1){
		return null;
	} else if(ver<10) {
		_countInputCounts = charcounts[0];
	} else if(ver<27) {
		_countInputCounts = charcounts[1];
	} else if(ver<41) {
		_countInputCounts = charcounts[2];
	} else {
		return null;
	}
	bitst.push(len,_countInputCounts);
	return bitst;
}

function calcRsBlocks(btstrage,ver,level){
	//http://void.yamicha.com/notebook/qr_list_rs.htm
	
}

function mapNew(version,bitstrage){
	var _mx = qrcode.symbol.mapNew(version)
	var matrix = _mx.length;
	var isUp = true;
	var isRand = false;
	for(var x=matrix-1;x>=0;x-=2){
		if(x==7){x--;}
		var _ys,_yi;
		if(isUp){
			_ys = 0;
			_yi = 1;
		} else {
			_ys = matrix-1;
			_yi = -1;
		}
		isUp = !isUp;
		for(var y=_ys;y>=0&&y<matrix;y+=_yi){
			if(_mx[y][x] && (_mx[y][x] >= 0x02)){continue;}
			_mx[y][x] = isRand?1:0;
			isRand = !isRand;
			_mx[y][x+1] = isRand?1:0;
			isRand = !isRand;
		}
	}
	
	
	//勝手に描画 
	var _canvas = document.getElementById('drawarea');
	var _cellsize = 4;
	if ( _canvas && _canvas.getContext ) {
		_canvas.width = _canvas.height = _mx.length * _cellsize;
		var ctx = _canvas.getContext('2d');
		ctx.width = ctx.height = _mx.length * _cellsize;
		ctx.fillStyle = "rgb(0, 0, 0)";
		for(var i=0;i<matrix;i++){
			for(var k=0;k<matrix;k++){
				if(!_mx[i][k] || !(_mx[i][k] & 0x01)){continue;}
				ctx.fillRect(k*_cellsize, i*_cellsize, _cellsize, _cellsize);
			}
		}
	}
	//テキストでの情報表示 
	if(false){
	for(var i=0;i<matrix;i++){
		for(var k=0;k<matrix;k++){
			$('#logarea').append((_mx[i][k])?_mx[i][k]:0);
		}
		$('#logarea').append('<br />');
	}
	}
}
/*
7
000010
011110
100110


8
010001
011100
111000

9
110111
011000
000100

10



*/
$(document).ready(function (){
	mapNew(7);
});

</script>
</head>
<body>
<h1>QUnit QRcode</h1>
<h2 id="banner"></h2>
<h2 id="userAgent"></h2>
<ol id="tests">
</ol>
<div id="main">
</div>
<div id="logarea"></div>
<canvas id="drawarea"></canvas>

</body>
</html>